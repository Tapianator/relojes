<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Colección - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner, .spinner-small {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        .spinner-small {
            border-width: 2px;
            width: 12px;
            height: 12px;
            border-top-color: #4f46e5;
            border-right-color: transparent;
            border-bottom-color: transparent;
            border-left-color: transparent;
        }
        .spinner-dark {
             border: 4px solid rgba(0,0,0,0.1);
             border-top-color: #333;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos para el Modal */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-content-enter { animation: scaleUp 0.3s ease-out forwards; }
        .modal-content-leave { animation: scaleDown 0.3s ease-in forwards; }
        @keyframes scaleUp { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes scaleDown { from { transform: scale(1) translateY(0); opacity: 1; } to { transform: scale(0.9) translateY(20px); opacity: 0;} }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword,
            signOut,
            setPersistence,
            browserSessionPersistence 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDoc,
            doc, 
            updateDoc, 
            deleteDoc,
            query,
            onSnapshot,
            arrayUnion,  // <-- NUEVO
            arrayRemove  // <-- NUEVO
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage,     // <-- NUEVO
            ref,            // <-- NUEVO
            uploadBytes,    // <-- NUEVO
            getDownloadURL, // <-- NUEVO
            deleteObject    // <-- NUEVO
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAkgJTV9LSPX9wLpj8M37OC8PG4ClleCxQ",
            authDomain: "sbx-relojes-web.firebaseapp.com",
            projectId: "sbx-relojes-web",
            storageBucket: "sbx-relojes-web-stg-fmdzxpsv8t73fbgyq2i3c", 
            messagingSenderId: "326032897645",
            appId: "1:326032897645:web:ca43eb5cee4e7bb4573164"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app, "relojes");
        const storage = getStorage(app); // <-- NUEVO

        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LepBPcrAAAAALCfr-9FnQjgBVZdJn_0ZRXpNVqR'),
            isTokenAutoRefreshEnabled: true
        });

        // --- Elementos del DOM ---
        const loginSection = document.getElementById('login-section');
        const adminSection = document.getElementById('admin-section');
        const loginForm = document.getElementById('login-form'); 
        const loginEmail = document.getElementById('login-email'); 
        const loginPassword = document.getElementById('login-password'); 
        const loginError = document.getElementById('login-error'); 
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const watchListContainer = document.getElementById('watch-list-container');
        const listLoader = document.getElementById('list-loader');
        
        // Modal de Edición (Texto)
        const editModal = document.getElementById('edit-modal');
        const editModalContent = document.getElementById('edit-modal-content');
        const editForm = document.getElementById('edit-form');
        const editSpinner = document.getElementById('edit-spinner');
        const editButtonText = document.getElementById('edit-button-text');
        
        // Modal de Borrado (Reloj)
        const deleteModal = document.getElementById('delete-modal');
        const deleteConfirmButton = document.getElementById('delete-confirm-btn');
        const deleteCancelButton = document.getElementById('delete-cancel-btn');
        let currentDeleteId = null; 
        
        // Modal de Imágenes (NUEVO)
        const imageModal = document.getElementById('image-modal');
        const imageModalContent = document.getElementById('image-modal-content');
        const imageModalLoader = document.getElementById('image-modal-loader');
        const imageGrid = document.getElementById('image-grid');
        const imageUploader = document.getElementById('image-uploader');
        const uploadSpinner = document.getElementById('upload-spinner');
        let currentEditDocId = null; // Para saber en qué reloj trabajar
        let currentEditFolder = null; // Para saber dónde subir imágenes

        let unsubscribeFromWatches = null; 

        // --- LÓGICA DE AUTENTICACIÓN ---
        setPersistence(auth, browserSessionPersistence); 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.classList.add('hidden');
                adminSection.classList.remove('hidden');
                userInfo.textContent = `Bienvenido, ${user.email}`;
                loadWatches(); 
            } else {
                loginSection.classList.remove('hidden');
                adminSection.classList.add('hidden');
                if (unsubscribeFromWatches) {
                    unsubscribeFromWatches(); 
                }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginEmail.value;
            const password = loginPassword.value;
            loginError.classList.add('hidden');

            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => {
                    console.error("Error al iniciar sesión: ", error);
                    loginError.textContent = `Error: ${error.message}`;
                    loginError.classList.remove('hidden');
                });
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- LÓGICA DE CARGAR/MOSTRAR RELOJES ---
        function loadWatches() {
            listLoader.classList.remove('hidden');
            const q = query(collection(db, "wathces"));
            
            unsubscribeFromWatches = onSnapshot(q, (querySnapshot) => {
                listLoader.classList.add('hidden');
                watchListContainer.innerHTML = ''; 
                
                if (querySnapshot.empty) {
                    watchListContainer.innerHTML = `<p class="text-gray-500">No se han encontrado relojes.</p>`;
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const watch = { id: doc.id, ...doc.data() };
                    const watchElement = createWatchRow(watch);
                    watchListContainer.appendChild(watchElement);
                });
            }, (error) => {
                console.error("Error al cargar relojes: ", error);
                listLoader.classList.add('hidden');
                watchListContainer.innerHTML = `<p class="text-red-500">Error al cargar la lista. Revisa la consola.</p>`;
            });
        }

        function createWatchRow(watch) {
            const div = document.createElement('div');
            div.className = 'bg-white p-4 rounded-lg shadow-md flex items-center justify-between space-x-4';
            
            const soldStatus = watch.isSold 
                ? `<span class="text-xs font-medium bg-red-100 text-red-700 px-2 py-0.5 rounded-full">Vendido</span>`
                : `<span class="text-xs font-medium bg-green-100 text-green-700 px-2 py-0.5 rounded-full">A la venta</span>`;

            div.innerHTML = `
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-semibold text-gray-900 truncate">${watch.name || 'Sin nombre'}</p>
                    <p class="text-sm text-gray-500 truncate">${watch.price || 'Sin precio'}</p>
                </div>
                <div class="flex-shrink-0 flex items-center space-x-2">
                    ${soldStatus}
                    <!-- NUEVO BOTÓN DE IMÁGENES -->
                    <button data-id="${watch.id}" class="image-btn p-2 text-gray-500 hover:text-purple-600" title="Administrar Imágenes">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg>
                    </button>
                    <button data-id="${watch.id}" class="edit-btn p-2 text-gray-500 hover:text-blue-600" title="Editar Texto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                    <button data-id="${watch.id}" class="delete-btn p-2 text-gray-500 hover:text-red-600" title="Borrar Reloj">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;
            return div;
        }

        // --- LÓGICA DE EDITAR, BORRAR Y GESTIONAR IMÁGENES ---
        watchListContainer.addEventListener('click', (e) => {
            const editButton = e.target.closest('.edit-btn');
            const deleteButton = e.target.closest('.delete-btn');
            const imageButton = e.target.closest('.image-btn'); // <-- NUEVO

            if (editButton) {
                const docId = editButton.dataset.id;
                openEditModal(docId);
            }
            if (deleteButton) {
                const docId = deleteButton.dataset.id;
                openDeleteModal(docId);
            }
            if (imageButton) { // <-- NUEVO
                const docId = imageButton.dataset.id;
                openImageModal(docId);
            }
        });

        // --- Edición (Modal de Texto) ---
        async function openEditModal(docId) {
            const docRef = doc(db, "wathces", docId);
            const snap = await getDoc(docRef);

            if (!snap.exists()) {
                console.error("No se encontró el documento para editar");
                return;
            }
            const watch = snap.data();

            document.getElementById('edit-id').value = docId;
            document.getElementById('edit-name').value = watch.name || '';
            document.getElementById('edit-price').value = watch.price || '';
            document.getElementById('edit-folder').value = watch.mainImage ? watch.mainImage.split('/')[0] : ''; 
            document.getElementById('edit-shortDesc').value = watch.shortDesc || '';
            document.getElementById('edit-longDesc').value = watch.longDesc || '';
            document.getElementById('edit-videoUrl').value = watch.videoUrl || '';
            document.getElementById('edit-isSold').checked = watch.isSold || false;

            editModal.classList.remove('hidden');
            editModal.classList.add('modal-enter');
            editModalContent.classList.add('modal-content-enter');
        }

        function closeEditModal() {
            editModal.classList.add('modal-leave');
            editModalContent.classList.add('modal-content-leave');
            editModal.addEventListener('animationend', () => {
                editModal.classList.add('hidden');
                editModal.classList.remove('modal-leave');
                editModalContent.classList.remove('modal-content-leave');
            }, { once: true });
        }
        
        editModal.addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal' || e.target.closest('#modal-close-btn')) {
                closeEditModal();
            }
        });

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            setEditLoading(true);

            const docId = document.getElementById('edit-id').value;
            
            const updatedData = {
                name: document.getElementById('edit-name').value,
                price: document.getElementById('edit-price').value,
                shortDesc: document.getElementById('edit-shortDesc').value,
                longDesc: document.getElementById('edit-longDesc').value,
                videoUrl: document.getElementById('edit-videoUrl').value,
                isSold: document.getElementById('edit-isSold').checked,
            };

            try {
                const docRef = doc(db, "wathces", docId);
                await updateDoc(docRef, updatedData);
                closeEditModal();
            } catch (error) {
                console.error("Error al actualizar el documento:", error);
                alert("Error al actualizar. Revisa la consola."); 
            } finally {
                setEditLoading(false);
            }
        });

        function setEditLoading(isLoading) {
            const button = document.getElementById('edit-save-button');
            if (isLoading) {
                button.disabled = true;
                editButtonText.classList.add('hidden');
                editSpinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                editButtonText.classList.remove('hidden');
                editSpinner.classList.add('hidden');
            }
        }

        // --- Borrado (Modal de Reloj) ---
        function openDeleteModal(docId) {
            currentDeleteId = docId;
            deleteModal.classList.remove('hidden');
            deleteModal.classList.add('modal-enter');
        }

        function closeDeleteModal() {
            deleteModal.classList.add('modal-leave');
            deleteModal.addEventListener('animationend', () => {
                deleteModal.classList.add('hidden');
                deleteModal.classList.remove('modal-leave');
            }, { once: true });
        }

        deleteCancelButton.addEventListener('click', closeDeleteModal);
        deleteModal.addEventListener('click', (e) => {
            if (e.target.id === 'delete-modal') closeDeleteModal();
        });

        deleteConfirmButton.addEventListener('click', async () => {
            if (currentDeleteId) {
                try {
                    // TODO: Borrar también las imágenes de Storage
                    const docRef = doc(db, "wathces", currentDeleteId);
                    await deleteDoc(docRef);
                    currentDeleteId = null;
                    closeDeleteModal();
                } catch (error) {
                    console.error("Error al borrar el documento:", error);
                    alert("Error al borrar. Revisa la consola.");
                    currentDeleteId = null;
                    closeDeleteModal();
                }
            }
        });

        // --- NUEVO: LÓGICA DE GESTIÓN DE IMÁGENES ---

        async function openImageModal(docId) {
            currentEditDocId = docId;
            imageGrid.innerHTML = ''; // Limpiar grid
            imageModalLoader.classList.remove('hidden');
            imageModal.classList.remove('hidden');
            imageModal.classList.add('modal-enter');
            imageModalContent.classList.add('modal-content-enter');

            const docRef = doc(db, "wathces", docId);
            const snap = await getDoc(docRef);

            if (!snap.exists()) {
                console.error("No se encontró el documento");
                closeImageModal();
                return;
            }
            
            const watch = snap.data();
            const mainImagePath = watch.mainImage;
            const galleryPaths = watch.gallery || [];
            currentEditFolder = mainImagePath ? mainImagePath.split('/')[0] : 'default'; // Guardar carpeta
            
            // Unir mainImage y gallery para no repetir, usando Set
            const allImagePaths = [...new Set([mainImagePath, ...galleryPaths])];

            if (allImagePaths.length === 0) {
                 imageGrid.innerHTML = `<p class="text-gray-500">No hay imágenes para este reloj.</p>`;
                 imageModalLoader.classList.add('hidden');
                 return;
            }

            // Cargar todas las imágenes
            const imagePromises = allImagePaths.map(async (path) => {
                try {
                    const imgRef = ref(storage, path);
                    const url = await getDownloadURL(imgRef);
                    return { path, url, isMain: path === mainImagePath };
                } catch (error) {
                    console.warn(`No se pudo cargar la imagen: ${path}`, error);
                    return { path, url: null, isMain: path === mainImagePath };
                }
            });

            const images = await Promise.all(imagePromises);
            imageModalLoader.classList.add('hidden');
            imageGrid.innerHTML = ''; // Limpiar por si acaso

            images.filter(img => img.url).forEach(img => {
                imageGrid.appendChild(createImageThumbnail(img.path, img.url, img.isMain));
            });
        }

        function createImageThumbnail(path, url, isMain) {
            const div = document.createElement('div');
            div.className = `relative group rounded-md overflow-hidden border-2 ${isMain ? 'border-blue-600' : 'border-transparent'}`;
            
            const mainBadge = isMain ? `<span class="absolute top-1 left-1 bg-blue-600 text-white text-xs font-medium px-2 py-0.5 rounded">Principal</span>` : '';

            div.innerHTML = `
                <img src="${url}" alt="${path}" class="h-40 w-full object-cover">
                ${mainBadge}
                <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center space-y-1 p-2">
                    <button data-path="${path}" class="set-main-btn text-xs bg-white text-black px-2 py-1 rounded-md hover:bg-gray-200 ${isMain ? 'hidden' : ''}">Usar como Principal</button>
                    <button data-path="${path}" class="delete-image-btn text-xs bg-red-600 text-white px-2 py-1 rounded-md hover:bg-red-700">Borrar</button>
                </div>
            `;
            return div;
        }

        function closeImageModal() {
            imageModal.classList.add('modal-leave');
            imageModalContent.classList.add('modal-content-leave');
            imageModal.addEventListener('animationend', () => {
                imageModal.classList.add('hidden');
                imageModal.classList.remove('modal-leave');
                imageModalContent.classList.remove('modal-content-leave');
            }, { once: true });
        }

        // Cierre de modal de imágenes
        imageModal.addEventListener('click', (e) => {
            if (e.target.id === 'image-modal' || e.target.closest('#image-modal-close-btn')) {
                closeImageModal();
            }
        });

        // Eventos de botones dentro del grid de imágenes
        imageGrid.addEventListener('click', async (e) => {
            const setMainBtn = e.target.closest('.set-main-btn');
            const deleteBtn = e.target.closest('.delete-image-btn');

            if (setMainBtn) {
                const path = setMainBtn.dataset.path;
                await setAsMainImage(path);
            }
            if (deleteBtn) {
                const path = deleteBtn.dataset.path;
                if (confirm(`¿Estás seguro de que quieres borrar la imagen ${path}? Esta acción no se puede deshacer.`)) {
                     await deleteImage(path);
                }
            }
        });

        async function setAsMainImage(path) {
            try {
                const docRef = doc(db, "wathces", currentEditDocId);
                await updateDoc(docRef, { mainImage: path });
                // Refrescar el modal de imágenes para mostrar el cambio
                await openImageModal(currentEditDocId); 
            } catch (error) {
                console.error("Error al establecer imagen principal:", error);
                alert("Error al actualizar la imagen principal.");
            }
        }

        async function deleteImage(path) {
            try {
                // 1. Borrar de Storage
                const imgRef = ref(storage, path);
                await deleteObject(imgRef);
                
                // 2. Borrar de Firestore (del array 'gallery')
                const docRef = doc(db, "wathces", currentEditDocId);
                await updateDoc(docRef, {
                    gallery: arrayRemove(path) 
                });

                // 3. Verificar si era la imagen principal
                const snap = await getDoc(docRef);
                if (snap.data().mainImage === path) {
                    // Si era la principal, la borramos (o la ponemos vacía)
                    await updateDoc(docRef, { mainImage: "" });
                }

                // Refrescar el modal
                await openImageModal(currentEditDocId);
            } catch (error) {
                console.error("Error al borrar la imagen:", error);
                alert("Error al borrar la imagen.");
            }
        }

        // Subir nuevas imágenes
        imageUploader.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length === 0) return;
            
            uploadSpinner.classList.remove('hidden');
            
            const uploadPromises = [];
            const newPaths = [];

            for (const file of files) {
                const newPath = `${currentEditFolder}/${file.name}`;
                newPaths.push(newPath);
                const imgRef = ref(storage, newPath);
                uploadPromises.push(uploadBytes(imgRef, file));
            }

            try {
                await Promise.all(uploadPromises); // Esperar a que todas suban

                // Añadir todas las nuevas rutas al array 'gallery' en Firestore
                const docRef = doc(db, "wathces", currentEditDocId);
                await updateDoc(docRef, {
                    gallery: arrayUnion(...newPaths)
                });

                // Refrescar el modal
                await openImageModal(currentEditDocId);

            } catch (error) {
                 console.error("Error al subir nuevas imágenes:", error);
                 alert("Error al subir imágenes.");
            } finally {
                 uploadSpinner.classList.add('hidden');
                 imageUploader.value = ''; // Resetear el input
            }
        });

    </script>

    <!-- Sección de Login (Ahora es funcional) -->
    <div id="login-section" class="flex items-center justify-center min-h-screen bg-gray-900">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-900">Iniciar Sesión - Admin</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                    <input id="login-email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="" placeholder="tu@email.com">
                </div>
                <div>
                    <label for="login-password" class="text-sm font-medium text-gray-700">Contraseña</label>
                    <input id="login-password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <p id="login-error" class="text-sm text-red-500 hidden"></p>
                <button type="submit" class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Sección de Administración (Oculta por defecto) -->
    <div id="admin-section" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-baseline space-x-4">
                        <h1 class="text-xl font-bold text-gray-900">Panel de Administración</h1>
                        <a href="admin.html" class="text-sm text-gray-600 hover:text-blue-600">Agregar Reloj</a>
                        <a href="editar.html" class="text-sm text-blue-600 font-semibold hover:text-blue-700">Editar Colección</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-sm text-gray-600"></span>
                        <button id="logout-button" class="px-3 py-1 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">Editar Colección de Relojes</h2>
                
                <div id="list-loader" class="text-center py-10">
                    <p class="text-gray-500">Cargando relojes...</p>
                </div>

                <div id="watch-list-container" class="space-y-4">
                    <!-- Los relojes se cargarán aquí -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Edición (TEXTO) -->
    <div id="edit-modal" class="fixed inset-0 z-40 flex items-center justify-center bg-black/70 hidden p-4">
        <div id="edit-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <form id="edit-form" class="p-8 space-y-6">
                <h3 class="text-2xl font-bold text-gray-900">Editar Reloj</h3>
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="edit-name" class="block text-sm font-medium text-gray-700">Nombre del Reloj</label>
                        <input type="text" id="edit-name" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-gray-700">Precio</label>
                        <input type="text" id="edit-price" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div>
                    <label for="edit-folder" class="block text-sm font-medium text-gray-700">Carpeta en Storage (Solo lectura)</label>
                    <input type="text" id="edit-folder" readonly class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
                </div>
                
                <div>
                    <label for="edit-shortDesc" class="block text-sm font-medium text-gray-700">Descripción Corta</label>
                    <textarea id="edit-shortDesc" rows="2" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div>
                    <label for="edit-longDesc" class="block text-sm font-medium text-gray-700">Descripción Larga</label>
                    <textarea id="edit-longDesc" rows="4" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>

                <div>
                    <label for="edit-videoUrl" class="block text-sm font-medium text-gray-700">URL Video YouTube</label>
                    <input type="text" id="edit-videoUrl" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div class="flex items-center">
                    <input id="edit-isSold" type="checkbox" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="edit-isSold" class="ml-2 block text-sm font-medium text-gray-900">Marcar como Vendido</slabel>
                </div>

                <div>
                    <button id="edit-save-button" type="submit" class="w-full px-4 py-2 font-medium text-white bg-green-600 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center justify-center">
                        <span id="edit-button-text">Guardar Cambios</span>
                        <span id="edit-spinner" class="spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmación de Borrado (RELOJ) -->
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h3 class="text-lg font-medium text-gray-900">Confirmar Borrado</h3>
                <p class="mt-2 text-sm text-gray-500">¿Estás seguro de que quieres borrar este reloj? Esta acción no se puede deshacer. (Las imágenes en Storage no se borrarán).</p>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button id="delete-confirm-btn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">
                    Borrar
                </button>
                <button id="delete-cancel-btn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- NUEVO: Modal de Administración de Imágenes -->
    <div id="image-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden p-4">
        <div id="image-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button id="image-modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="p-8">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Administrar Imágenes</h3>
                
                <div class="mb-4 p-4 bg-gray-50 rounded-md border">
                    <label for="image-uploader" class="block text-sm font-medium text-gray-700 mb-2">Subir nuevas imágenes a la galería</label>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="image-uploader" accept="image/*" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <div id="upload-spinner" class="spinner-small hidden"></div>
                    </div>
                </div>

                <div id="image-modal-loader" class="text-center py-10">
                    <div class="spinner spinner-dark mx-auto"></div>
                    <p class="text-gray-500 mt-2">Cargando imágenes...</p>
                </div>
                
                <div id="image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- Las imágenes se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

</body>
</html>