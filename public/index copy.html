<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitrina de Relojes Exclusivos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-content-enter { animation: scaleUp 0.3s ease-out forwards; }
        .modal-content-leave { animation: scaleDown 0.3s ease-in forwards; }
        @keyframes scaleUp { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes scaleDown { from { transform: scale(1) translateY(0); opacity: 1; } to { transform: scale(0.9) translateY(20px); opacity: 0;} }
        .loader, .img-loader::before {
            content: '';
            box-sizing: border-box;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader { width: 40px; height: 40px; }
        .img-loader { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.5); }
        .img-loader::before { width: 30px; height: 30px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- ===== Header ===== -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <a href="#" class="text-2xl font-bold tracking-wider text-white">CHRONOS</a>
                </div>
                <nav class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#hero" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Inicio</a>
                        <a href="#about" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Nosotros</a>
                        <a href="#collection" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Colección</a>
                        <a href="#contact" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Contacto</a>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <!-- ===== Hero Section ===== -->
        <section id="hero" class="relative h-[60vh] md:h-[80vh] flex items-center justify-center text-center overflow-hidden">
             <!-- Video Background -->
             <video autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover -z-10">
                 <source src="video/test.mp4" type="video/mp4">
                 Tu navegador no soporta el tag de video. Considera usar una imagen de fondo como fallback.
             </video>
             <!-- Overlay -->
            <div class="absolute inset-0 bg-black/60"></div>
             <!-- Content -->
            <div class="relative z-10 px-4">
                <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-white mb-4">Elegancia Atemporal</h1>
                <p class="text-lg md:text-xl max-w-2xl mx-auto text-gray-200 mb-8">Descubre nuestra exclusiva selección de relojes, donde la precisión se encuentra con el diseño.</p>
                <a href="#collection" class="bg-white text-gray-900 hover:bg-gray-200 font-bold py-3 px-8 rounded-lg text-lg transition duration-300">Ver Colección</a>
                            </div>
        </section>

        <!-- ===== About Section ===== -->
        <section id="about" class="py-20 bg-gray-800">
             <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center">
                 <h2 class="text-3xl md:text-4xl font-bold text-white mb-6">Nuestra Pasión</h2>
                 <div class="max-w-3xl mx-auto text-gray-300 space-y-4">
                     <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                     <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                 </div>
            </div>
        </section>

        <!-- ===== Collection Section ===== -->
        <section id="collection" class="py-20 bg-gray-900">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-white">Nuestra Colección</h2>
                    <p class="text-gray-400 mt-2">Piezas maestras de la relojería moderna y clásica.</p>
                </div>
                <div id="watch-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8 min-h-[300px] flex items-center justify-center">
                    <div id="loader" class="loader"></div>
                </div>
            </div>
        </section>

        <!-- ===== Contact Section ===== -->
        <section id="contact" class="py-20 bg-gray-800">
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-3xl font-bold mb-4">¿Interesado en una pieza?</h2>
                <p class="text-gray-300 max-w-xl mx-auto mb-8">Contáctanos para consultas o para coordinar tu compra.</p>
                <a href="https://wa.me/56912345678?text=Hola,%20estoy%20interesado%20en%20uno%20de%20sus%20relojes." target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 inline-flex items-center">
                    Contactar por WhatsApp
                </a>
            </div>
        </section>
    </main>

    <!-- ===== Footer ===== -->
    <footer class="bg-gray-900 border-t border-gray-700">
        <div class="container mx-auto py-6 px-4 text-center text-gray-400">
            <p>&copy; 2025 CHRONOS. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- ===== Modal ===== -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 hidden modal-enter">
        <div id="modal-content" class="bg-gray-800 rounded-lg shadow-xl w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto relative modal-content-enter"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Importar App Check (usando ReCaptchaV3Provider) y getToken
        import { initializeAppCheck, ReCaptchaV3Provider, getToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";

        // --- CONFIGURACIÓN DE FIREBASE ---
        // (Usa la configuración de tu proyecto)
        const firebaseConfig = {
            apiKey: "AIzaSyAkgJTV9LSPX9wLpj8M37OC8PG4ClleCxQ",
            authDomain: "sbx-relojes-web.firebaseapp.com",
            projectId: "sbx-relojes-web",
            storageBucket: "sbx-relojes-web-stg-fmdzxpsv8t73fbgyq2i3c",
            messagingSenderId: "326032897645",
            appId: "1:326032897645:web:ca43eb5cee4e7bb4573164"
        };
        
        // --- URL DE TU CLOUD FUNCTION ---
        const getSignedUrlFunctionUrl = 'https://us-central1-sbx-relojes-web.cloudfunctions.net/getSignedUrl';

        const app = initializeApp(firebaseConfig);

        // --- INICIALIZACIÓN DE APP CHECK (RECAPTCHA V3) ---
        const appCheck = initializeAppCheck(app, {
            provider: new ReCaptchaV3Provider('6LepBPcrAAAAALCfr-9FnQjgBVZdJn_0ZRXpNVqR'), // Tu clave v3 Clásica
            isTokenAutoRefreshEnabled: true
        });

        const db = getFirestore(app, "relojes");
        let watchesData = [];
        const signedUrlCache = new Map();

        // --- FUNCIÓN PARA OBTENER URL SEGURA Y TEMPORAL ---
        async function getSignedUrl(filePath) {
            if (!filePath) {
                console.error("Error: se intentó obtener URL para una ruta de archivo vacía.");
                return 'https://placehold.co/600x600/1a202c/ffffff?text=Ruta+no+especificada';
            }
            if (signedUrlCache.has(filePath)) {
                return signedUrlCache.get(filePath);
            }
            try {
                // *** INICIO DE LA CORRECCIÓN ***
                // 1. Obtener el token de App Check manualmente
                let appCheckTokenResult;
                try {
                    appCheckTokenResult = await getToken(appCheck, /* forceRefresh= */ false);
                } catch (err) {
                    console.error("Error al obtener el token de App Check:", err);
                    throw new Error("Error de App Check");
                }

                // 2. Adjuntar el token como un Header en el 'fetch'
                const response = await fetch(`${getSignedUrlFunctionUrl}?filePath=${encodeURIComponent(filePath)}`, {
                    headers: {
                        'X-Firebase-AppCheck': appCheckTokenResult.token,
                    },
                });
                // *** FIN DE LA CORRECCIÓN ***

                if (!response.ok) {
                    console.error(`Error en la respuesta de la Cloud Function: ${response.status} - ${await response.text()}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                signedUrlCache.set(filePath, data.url);
                return data.url;
            } catch (error) {
                console.error(`Error CRÍTICO al obtener URL firmada para '${filePath}':`, error);
                return 'https://placehold.co/600x600/1a202c/ffffff?text=Error+al+cargar';
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const watchGrid = document.getElementById('watch-grid');
            const loader = document.getElementById('loader');

            try {
                // App Check protege esta llamada automáticamente
                const querySnapshot = await getDocs(collection(db, "wathces"));

                if (querySnapshot.empty) {
                    loader.style.display = 'none';
                    watchGrid.innerHTML = `<p class="text-yellow-400">No se encontraron relojes en la base de datos.</p>`;
                    return; 
                }

                watchesData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                loader.style.display = 'none';
                watchGrid.classList.remove('flex', 'items-center', 'justify-center');
                await renderWatches();
            } catch (error) {
                console.error("Error CRÍTICO al obtener los relojes de Firestore: ", error);
                loader.style.display = 'none';
                watchGrid.innerHTML = `<p class="text-red-400">No se pudo cargar la colección. Revisa la consola para más detalles.</p>`;
            }

            // --- FUNCIÓN PARA CREAR TARJETAS ---
            async function renderWatches() {
                watchGrid.innerHTML = '';
                for (const watch of watchesData) {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer relative';
                    
                    const watchName = watch.name || "Nombre no disponible";
                    const watchShortDesc = watch.shortDesc || "Descripción no disponible.";
                    const watchPrice = watch.price || "Precio no disponible";
                    const mainImage = watch.mainImage || watch.mainimage;

                    const soldOverlay = watch.isSold ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><span class="text-white text-2xl font-bold border-2 border-white py-2 px-4 rounded-md">VENDIDO</span></div>` : '';

                    card.innerHTML = `
                        <div class="relative h-72 bg-gray-700">
                            <div class="img-loader"></div>
                            <img class="w-full h-full object-cover hidden" data-src="${mainImage}" alt="${watchName}" />
                            ${soldOverlay}
                        </div>
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-white mb-2">${watchName}</h3>
                            <p class="text-gray-400 mb-4">${watchShortDesc}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-white">${watchPrice}</span>
                                <button data-id="${watch.id}" class="view-details-btn bg-white/10 hover:bg-white/20 text-white font-semibold py-2 px-4 border border-transparent rounded-lg transition">Ver Detalles</button>
                            </div>
                        </div>
                    `;
                    watchGrid.appendChild(card);
                    
                    const imgElement = card.querySelector('img[data-src]');
                    const loaderElement = card.querySelector('.img-loader');
                    try {
                        const url = await getSignedUrl(mainImage);
                        imgElement.src = url;
                        imgElement.onload = () => {
                            imgElement.classList.remove('hidden');
                            if(loaderElement) loaderElement.style.display = 'none';
                        };
                        imgElement.onerror = () => {
                             console.error(`Error: No se pudo cargar la imagen desde la URL firmada para ${watchName}.`);
                             if(loaderElement) loaderElement.innerHTML = `<p class="text-xs text-red-300 p-2 text-center">Error al cargar imagen</p>`;
                        }
                    } catch (e) {
                         if(loaderElement) loaderElement.style.display = 'none';
                    }
                }
            }

            // --- FUNCIÓN PARA ABRIR MODAL ---
            async function openModal(watch) {
                const modalContent = document.getElementById('modal-content');
                modalContent.innerHTML = `<div class="flex justify-center items-center p-8"><div class="loader"></div></div>`;
                
                const modal = document.getElementById('modal');
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                const galleryUrls = watch.gallery && Array.isArray(watch.gallery) 
                    ? await Promise.all(watch.gallery.map(getSignedUrl)) 
                    : [];
                
                const galleryHtml = galleryUrls.map(url => `<img src="${url}" alt="Vista de ${watch.name}" class="w-full rounded-md object-cover">`).join('');
                const videoHtml = watch.videoUrl ? `<div class="mt-6"><h4 class="text-xl font-semibold mb-2 text-white">Video</h4><div class="aspect-w-16 aspect-h-9"><iframe class="rounded-lg" src="${watch.videoUrl}" frameborder="0" allowfullscreen></iframe></div></div>` : '';
                const buyButton = watch.isSold ? `<div class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg text-center">Vendido</div>` : `<a href="https://wa.me/56912345678?text=Hola,%20estoy%20interesado%20en%20el%20reloj%20${encodeURIComponent(watch.name)}." target="_blank" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition inline-flex items-center justify-center">Comprar por WhatsApp</a>`;

                modalContent.innerHTML = `
                    <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <div class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-3xl font-bold text-white mb-4">${watch.name || "Sin nombre"}</h3>
                            <p class="text-gray-300 mb-6">${watch.longDesc || "Sin descripción."}</p>
                            <span class="text-2xl font-bold text-white block mb-6">${watch.price || "Sin precio"}</span>
                            ${buyButton}
                        </div>
                        <div class="space-y-4">${galleryHtml}${videoHtml}</div>
                    </div>
                `;
            }

            // --- EVENT LISTENERS ---
             watchGrid.addEventListener('click', e => {
                 const button = e.target.closest('.view-details-btn');
                 if (button) {
                     const watchId = button.dataset.id;
                     const selectedWatch = watchesData.find(w => w.id === watchId);
                     if (selectedWatch) openModal(selectedWatch);
                 }
            });

            document.getElementById('modal').addEventListener('click', e => {
                if (e.target.id === 'modal' || e.target.closest('#close-modal-btn')) closeModal();
            });
            
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && !document.getElementById('modal').classList.contains('hidden')) closeModal();
            });

            function closeModal() {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                modal.classList.add('modal-leave');
                modalContent.classList.add('modal-content-leave');
                modal.addEventListener('animationend', () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('modal-leave');
                    modalContent.classList.remove('modal-content-leave');
                    document.body.style.overflow = 'auto';
                }, { once: true });
            }
        });
    </script>
</body>
</html>